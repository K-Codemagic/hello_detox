# Check out https://docs.codemagic.io/getting-started/building-a-react-native-app/ for more information
# Please review and update values in curly braces

workflows:
  react-native:
    name: Android Detox
    environment:
      vars:
          # Android Keystore environment variables
          CM_KEYSTORE: Encrypted(Z0FBQUFBQmZuYXR3QkFPcEd4MlZybFpmYkQtYVYwWExvb0JHaE1femVXTHlVd0ZQVDRyTnhRa0tfMXBFQlYtcUkyLXNwLW5KdEs0aVZiN05EUmFRNTd4TlYzS2JDMERTam5KaUJBRFphTThRV2JFZ1pVcnp4WW02b2FMd1FQV0pPNzhwSk12ZEk5SWw0U25wa19CdXgxZk5KNGFQSWtjQU0xR2RzcWQ4a2JnWDBaSmJrdVV6amQtdnh0UnowTjJmR0RwZ3dYZVotRW8yQ2RqZEFvYmpDbGQ0djAwTmRVdVYzemxwUG44VVhuNnBHSVJmYTBNNEZUTVRHTW1yNm52NkxEREt6NEd3LUd4aVhSMjVvY01PWFZYT3l6X0pWUHBKek5NeV9yTjhUNW42cDFyOXM4Wjl2X2NkQlJoQXJ6NHZZbFRwSUZKcC1weXRid2VnSEl3RkJ0b2NYYUs5c2NvTDhKendTY2pNZ3dwSjM2RHhmYmRPSVZPMWZIT2d3WWg1NG5vWlp0Q29fUXRvZXV1Y2Y2VV8yS3lUQm9GN0RkNHVvS3UtZWZibHA0UEE5cUh3cHlEOENnUTMwLUpjdVY2S3kxWU96RFlwbEhiR00xWWVJcy12NDRyeXhIZDJEd1RIQUxRN09hTTEzbV9TcUV3VDVrVkpVY0k0RWt5TFdRWlRkZThGN0xJN0xhYWRZRDQ5aXJsSTVfWWFTYWwyLV9qWEgyM2xoTGtBZDl0QXU1QVNYd1BqOVlncmxIMlEteU9tdFFqRFkwclJjVHBUOWUxWGhPVGYtdWd5V3JvU2JwSnVWVllmc290VlJpVjRGRXFZYkRhemNvSUdDNFgxRU5zOWdOTW1uVFlJZlQzMV9zX003M0FLNWZQRnNzS1dKcHNHa1ZObzVkcldWMWdrWWZTS1NsTzFpdlZBSnVQVXBUM3doTVFxOWE1UXBJV093Nm02LXJZVHhQcnZXVm9LVERwTnR6WkFwLVdJc2IzZi1iQXNOTG42TjllQlIxczlmOUlsVzNPR3Npbjh0SEMzZ1FLODBWVVhGcVFucm1oZjZSd05RdGJsMDVsSE5XRUdaX1pyS0c3OWVPeXF1UjZzMlZVekY3NVJqTDQ0WWRYRnFGRDdqUUVHMUN0V2o3NzdnMzFKWEZZbmtac2ZYTTFRWld0M2k0eHdaQVNuQU56MkJJazZGOWtuZU5pNVhETm9ZRmRFRkFsSlJ0ODJCblhLRkUzeEU4TEZaRmpZOGNqaHM5SUhVVXZQOWQ2M1F1MUlBOHR0STR0UjRsWFlYV0xRcFh4djJCbjdjOVoxVklQbnM0WGlOSTFLQkRGYnNCWFVXNWx3Rk1yS3RETVktRDNPa0xlbGJwTHRWa3BqM0dqNXpzZFZ4R3lna2s2Nm9BVm80TVJlRkhidzR0YTFuMlZ1dzBZZ2xVWEQwNWNUTlFKTTVHT0JzX0RpMHVfUmlXRFMxbDFVQkV4TzdIdXZ3Ync5YUFQTEctMGU5TzFNLXZEWHJtOGc2TDBxZ19fY0VJd2FPNU9Cc1JPbU5IWTBQZDgtX3kzYUxHdzh1VG9pd3QxRFlkRHp6VXBhVkU0d2tFT28xUkQ1dVJEdmg0RVdrS3UzUVhYRFpmMGZDTlVpd0RoTXBlUVAyOWdReWlaYjlMRDlQVjdSTlB1TlVUX0VUMzJMYlpGd3ZtcTlneTJVak1jVlI2Vk0wWS1hbk9fVWQxby1JUFFINl9rMDQ1aGdOSy0xbmx3YmszR1FkN2xXcFpOaFZYVTJDZ2x2TXNXY3FObEdGNkl0Ny1SSmUydDkwUkZLODhVUFg3dzJPak02bktiNVg4MFJXR3BOZFRsZTdsNTBJVU54eEJCcDAyckZEZk9ZSkdoQWFlaVlLX3F5UVhUSllSLTR6enJfZWZvc3l4RmItdkRGeUduVnoxd0VpWnFhMEd3SUh3YmVpWEZ4Rl9Dbi1ucTczQU9pLURaU0Y4cC0zdEpTSWVpNlhPSXh0YTFwNzZ2T3IzWTI2dnozUk15eFk2d1JDOHNkUlBJN0xsT0NabFNwU2xXU0ZpNC1aZllGSlFOeW5SYnpHM1lnelhNVHBpOU56b2lrZXJKOFJLS0FXUXRLLUlpMlVubWwxeThmZmNMb3ZqU3VSY2ltUGpsUG05a0RKVUZMQVV0VVpodlVxSWExbjY5ZENYTzZFQjJuYzRvTFJfNHVQT2FXVzB3SzVwd2haYU9reXFveWJGdVdVRHQ5WUR6VllobElVRHpPb2RWSVY3c2FHSWR2Mk4wenB0NEZCYk5jcVloUjZOV3pfa0hTVUVfUExjTUNzMzBiNlB0eDd4clZWbEhWTTAwdEpNR243VTdLM3Q5aWVWaEhDVlhxeWxfcE1CVGJaaGZJbWQxNXFxazNOSERjeVMzYi1ndEQ4NWhCQzBkdmNQbU1fVHNZSHpSdzlldWt3NXctM2tyWGRBbDl1MkJEckc4SVBpeWpzRzVEeXJQbE11blN0Y29HX24xeU93VTlDbjhCVzhFUENJd3VvWklIOW05cGo1bVE0YVgyTjBwZmVsXzNPSEdZdTU4UWQ4aGhSR0R3UnhXMUFWVC16SzVRaHNFZ25XOGtHM0x6MWdQVzAydUplREhpb2M5YkZrX3pnVnpEemtwdEVrbmF0TUFNcXZ4QWlXY0pjc3hwbHNDckctNWRGU1lqZG0yZnQxQ0NOOVJOZjF5M1BLTmJ2aFhsbXdNRTRrTlg1elBsNG1RVTFZekU4WGMzRDJZNEZ2WV9xMnF1N3c5SG1QLUp2NS1FSkdQekJzamUxaF9peVRuSlBlVC1FaEM5QVZnSl93clFid1dNRFhNWFVrVXZMMzVTSjRqWV91T0VqSVQ1R0tDRmk2cHBZVWVkTmRfUzN0Zi1YRUMtMDBibzU5SG1ULXh2TGJUaDFUelRaVGE4SU9uUXRENm5xbTNaSjNEeU1qemU4akhSRFA5dVFKNTc5Unl0eDlqYkRjSDlQSHk0UUdTUUktQk9XdjZBS0R4VlZvNEJLVGh1bEQ0d1FNR2pEanh5T2hNV0hlS040QlZGaDV5NmxVaFdvblhjUzRyOVdVOERiY01lMDZYMFAwZEp4dVVfd21QbzRFanhCYU1ISThWdmx0S2tuWmg2U0ppOHd5WjFJRnZIaWlYV2l0SXBtNnkzMDlndi04Tmd2RkJxVy0yMFpmQlFwdUZmVHpqS3Y0SEZ0cUVmYTJGVnUxVl9QWENaZWRyaWNoV1J3Y0tiU09TYnZsb3BDWkRTR2J5M0JzdVRqVWZNLXdXbmRtSzhzNnA3cGViV1lhUnIyWXVrbHkwUUlFY2tsd29KUmZiN0FTbW1jbGZyZGFmcm1RTWU3ZW5lNUpxbEN5SDIxQzBtWjlWdk1kZ2FfMFNkSUNnY08wVDRmbkREb1VpUUtHcTJ5TkFHOFhPLXRPaThtZmFvVU5YX3gwRXVWVVF4ZWdEd1dZZ1hyaDJjSExiSndVdFhjd3pSUVRCeDFfRzBjNjRHbTJFLUFvTHNkaW1TZnRFS1Zxd0NzVHNhMFpuckV5MkhadzF6VGtodmlaWVEyMjdSMllMeXZUN3lOcE4tQ3dxVmhmM3NQM3M2SWszN2ZvTTZQVUV4Ql8wQ3JFX1BLUWtPTnBtU0ZQN0Zod0RSOTdXUWFSNWNvUC1YaktIZkpyN29DVklhRVROWWsyem1aVGJNdkJjbVhWZE5wMTd5VUJVZkhrS1FraUdaNVI5dWJ2ZWJHYjNQSV95VVFBNkJoOFZfdjUyaXFYbW1oZkJfZ0pPenNtQTNEUHdETzZJSFU5aHFZaVI0T2p0MnE0a0dHaE44MEJWZGllVDByTVFsUmJyUTJkbVdRV19xYlR0akR6WXRvRkVhSUFkZEtsbVd1Yk56Sjl6ZHZ1MlNTcmctdDBEcUxsQjN6Y3RYemNDLTkxQy1KQl9RWkxwb3BqcXBRR1dJWDdZRVpzaHUtRXJzemV6MGp6b1drOVFoU2duX1VGUFdVSU9rVDVxdDhJRnlCS1h1OTlEYkJKVktRdkxmUW9ycXpwSTNROGFObnhSTGtNZ2tuakJfMXlQWjZGMjM3cGNad0wtMExMQVZ0YkhzUnBGSHViaHVxMGVudGJFemVtY0JqWkJyNlp5YVQ3aWtIX1BNWExyYlBlN05odElmWDhKdkU5MGYwV3U0bndWSEVHR1BJRjNzTVo5cHhhMnVraXQtbDU1TzlEUXM3Y0JfRENyb3BWNW1iS2dEeUNmSlUxWWtqWnNlLU1ZVFlQVDFSUFozYUppQmZDQmhPa3lDUW55Y3VjUlBTYkl1Ri1WUS1xaUpUUVo4Y0JUVVE0N3puX1puYXdRb2VOUlZtLUJMN25NOGZrbENYaTlmdmt3cjFmcG4yNnJMSldTQjlJanhjcEtjMFRpbVFWMzUwMk93aUplVEV5MnczLXlRVE1yWm0yQTlZOU92LW5yanozYS1HdTNhZ2ZuY0U1aElrTENVb25oWlo0VU4wV2M4WFlROU92NlBqQTNqVmlUMVlXMDNMT2JUc181X1FwTTNXSlZFTzBFQ1pGQ0tFZnRWbG1FRHZ5cVlUNmpVMHY2eUhNVmw1dmlYN1FNOWpBRnhYdzloT3FBb2NpNmF5N19QUWVueUNVYVBOM00ybkJCVnVQWmRmWTQ1RDhnSnlUR3hGRlVOWEhjRGRhemNaMUFQTFJvbnhvSEFIRWtJQ2dRQy00ODhoUU9wUkVacmFVQkNaWHQ5MHBub1YxdGk1dGI2QU5zV05NekNyRmFCbzVqZ2hiclRvNE11NFBRbTdQcEtCU0cxYzlFZzhDOXFoQ05nSW1rVE5RelJwM1dUNmo1b1pibTRkZ0QzWlN4TVhoQ0ZqQWV0NTJscHVhOHFQb0ZiZVMzdWdPQWMzNUliRkpOTUFHUUtHLVhOU1N2VURaeVAtaGozQ3p3dU1yWnJxMFM1S3ZFVWFONXBGWmFYcU5XRzJsUzhYZ2trNFI2em1uVW0tVHlMcGxUM3BseUZJSDhCTWkxLVVHNHNkVlRFNkt3UlB4cUxIY2N1YThNTG9XMDd3end3SldlVGp5NE5FdGpCbm5tZFFzYjRGNkp0cVdIaGtrN2Y5c0l2WVVzZ3pVMkFsQkdaN1UtaUtSSks4UGNGOVZjdVIzZ21QQjFERDBJNFlBNE5vQ3JJMnpyc3prNTIxbkZuWHo0aVBhakMxWVVOMFlWU05KZWNXYXdzT1R0YWw2UGNwRy10bWs5TU1CMlNXRjdDSWZCdEUxNnlwRTV0aDRrd2ZiT3Zhekk5aW0wbEs2STQzSzR3UlRJTkZQaVpaWkluREYyZVFRWldFS2JobXZ4ZzYwSXVCUDZUSGxPNGRqc0pGa1phVWtya2thbm5JYUlTMU9wZGtDeFVpOVJqcE5GZnlpTjB6bEVEc21LUzBpZkdLWjJxeWxmel9ISHJ6YnFBdF9SenlwcUZ1RWJEU3ZWR2o3Z00ybTdPTnRZNy1wazlXRzBYMVN5ZDhVN1VIUXFrQXRWTGh5LWxNOVBTcmFwOGptTG5IZXp5TUpQa2dSM3pJSUxYRmVpcDdzZDc1VGk0QWljdUJ1N1ZqRHdrNXlYUlBYTmxHbDd2dXNKZE4zYThRYW5XeThReGRESllJRmZieHVVTXFBb2t3eHh0b0xZZXlmVUpjcXVTSVRSRVRTZEF4Z25PSFF2Q0ZiX0F2bHhoeHRxRDhsOU41YTJsSDFaMTlKOVpiQTlpdjF6bk5nRG9RLWNkbklVVUpPLTEtS3hfRURVdW5MTVloaGt0S3lFcG50bC04NEZYcWtsaDVVQWo3bFJ2YUJkUjFranR3WmFPNTQwVWlOd2s2d0V0NFcyMmcwdWlYSlgyeVlfQnVLZzR4QUJrUTFNbjJYVFF0dWhZYmVBZ0JMdTFCTGh0VXlkdVczekh6Q2YxV25XRGFBb1ZPbGdiT3VLcUVrTWN6WnhVdWRiVFIyZF9fTU95VUR4UjRVX0JHRk4wX01TWkp4TG9aVEVabktFNFlpenlyaHFrYnpkNVI2NGlKTmZlbjd0c1ZqTWMzNUdtcVljZk1HZVFZRThhbjdncGdxMV96bXZPZ0JxV2ZkVFBrX3BiY01xUUhOS2M0QXR5a0wyWDh3cUFOVHVCYTdBVGV5bWZORXFPZ194aHBCWlNMYXI2dXBiTWYzYk9Kb2syRFZlUkJ3eEZXOG9idkUyUUhsMkZYNFppRGljLTdacDFyTTFXQTgwaXpwbjRiZkVhX1I2Ng==)
          CM_KEYSTORE_PASSWORD: Encrypted(Z0FBQUFBQmZuYXg0VHlQTTJIX3RiYjNadHBOQy10c01CdEV3QUVsRTk0REtMdGR2RlBZalo2aDJlMWYxX0Y1SnpUTkRBbkVxUmJVQ0dkYmkwSlRtWGY5QkxJSWNsNjBHTUE9PQ==)
          CM_KEY_ALIAS_PASSWORD: Encrypted(Z0FBQUFBQmZuYXg0VHlQTTJIX3RiYjNadHBOQy10c01CdEV3QUVsRTk0REtMdGR2RlBZalo2aDJlMWYxX0Y1SnpUTkRBbkVxUmJVQ0dkYmkwSlRtWGY5QkxJSWNsNjBHTUE9PQ==)
          CM_KEY_ALIAS_USERNAME: Encrypted(Z0FBQUFBQmZuYXlaYnFkUHpoY29KMnY1NVVId09JMk9YSnA5Y3ZsQjc3UlZxUU1IWHVRN1p3Vjd1LUF0TG54dFJOd2ZtNGRRbnNSdS1MOWxJamF2M3FoOEJSaWliTTM5Q1E9PQ==)
      node: latest
    scripts:
      - name: Install npm dependencies
        script: |
          npm Install
      - name: Install detox dependencies
        script: |
          brew tap wix/brew
      - name: Install detox-cli
        script: |
          npm install -g detox-cli
      - name: Set Android SDK location
        script: |
          echo "sdk.dir=$HOME/programs/android-sdk-macosx" > "$FCI_BUILD_DIR/android/local.properties"
      - name: Set up keystore
        script: |
          echo $CM_KEYSTORE | base64 --decode > /tmp/keystore.keystore
          cat >> "$FCI_BUILD_DIR/android/key.properties" <<EOF
          storePassword=$CM_KEYSTORE_PASSWORD
          keyPassword=$CM_KEY_ALIAS_PASSWORD
          keyAlias=$CM_KEY_ALIAS_USERNAME
          storeFile=/tmp/keystore.keystore
          EOF
      - name: Build with Detox
        script: |
          detox build -c android.emu.release
      - name: Test with Detox
        script: |
          detox test -c android.emu.release
      - name: Build Android release
        script: |
          cd android
          ./gradlew assembleRelease
    artifacts:
      - android/app/build/outputs/**/*.apk
